<!DOCTYPE html>
<html>
<head>
  <title>ICO Loan Dashboard</title>

  <!-- PDF Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>

:root {
  --primary: #0f2a44;
  --secondary: #1e4e79;
  --light-bg: #f4f7fb;
  --card-bg: #ffffff;
  --border: #dce3ec;
  --success: #1b8f3c;
  --danger: #c0392b;
  --button: #2563eb;
}

body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: var(--light-bg);
  padding: 20px;
  margin: 0;
}

h2 {
  color: var(--primary);
}

h3 {
  color: var(--secondary);
}

.filters {
  background: var(--card-bg);
  padding: 20px;
  border-radius: 8px;
  border: 1px solid var(--border);
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  margin: 20px 0;
}

select {
  padding: 7px 10px;
  border-radius: 5px;
  border: 1px solid var(--border);
  margin-right: 10px;
}

button {
  padding: 7px 14px;
  border: none;
  border-radius: 5px;
  background: var(--button);
  color: white;
  font-weight: 500;
  cursor: pointer;
}

button:hover {
  opacity: 0.9;
}

.summary {
  background: var(--card-bg);
  padding: 15px;
  border-radius: 6px;
  border: 1px solid var(--border);
  margin-top: 15px;
  font-size: 16px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: var(--card-bg);
  border-radius: 8px;
  overflow: hidden;
}

th {
  background: var(--primary);
  color: white;
  padding: 10px;
}

td {
  padding: 9px;
  border-bottom: 1px solid var(--border);
  text-align: center;
}

tr:hover {
  background: #f1f6fc;
}

.positive {
  color: var(--success);
  font-weight: bold;
}

.negative {
  color: var(--danger);
  font-weight: bold;
}

.pdf-only {
  display: none;
}

  </style>
</head>


<body>

<h2>ICO Loan Portfolio Dashboard</h2>
<h3 id="monthBox"></h3>


<!-- FILTERS -->

<div class="filters">

  <b>File:</b>
  <select id="fileFilter"></select>
  <button onclick="clearFile()">Clear</button>

  <br><br>

  <b>Client:</b>
  <select id="clientFilter"></select>
  <button onclick="clearClient()">Clear</button>

  <br><br>

  <button onclick="exportPDF()">ðŸ“„ Export PDF</button>

</div>


<!-- OUTPUT AREA -->

<div id="pdfArea">

  <!-- PDF HEADER -->

  <div id="pdfHeader" class="pdf-only">

    <h2>ICO Loan Statement</h2>

    <p><b>Month:</b> <span id="pdfMonth"></span></p>
    <p><b>File:</b> <span id="pdfFile"></span></p>
    <p><b>Client:</b> <span id="pdfClient"></span></p>

    <hr>

  </div>


  <!-- SUMMARY -->

  <div class="summary" id="summaryBox"></div>


  <!-- TABLE -->

  <table>

    <thead>
      <tr>
        <th>Client</th>
        <th>Receivable</th>
        <th>Payable</th>
        <th>Net Balance</th>
      </tr>
    </thead>

    <tbody id="tableBody"></tbody>

  </table>

</div>


<script>

const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhPqLQkZdsba5QlRl0izaDKRwzQp-Ps539FONA15jmXtHtZrqsiXwrQTPUkQBrP32cIVP2cTQKpc4KNwjGhJzgZun1Se5YBAbl_SVNrdjnOqLT0Di8RrF_-6kW2UNHBdoa9jIBHnVw7rK7XnxGUc8leQnRiRd0EOhrBCuFTdAxB-Iy2gwU0ynwPADycn-xzHwq81ybe7DQkAMXthuWCqIa9VY7EwVO8vVtbm3WOYHIKwAitgRSIuob71m80pynFjAqKG1EXk_BeqiIgRWLX8NKpoOc1iA&lib=M-FDxnB1VGCZDyM5l-Eicf7eUs6YUnKQP";


let allData = [];
let currentMonth = "";


// LOAD DATA

fetch(API_URL)
  .then(res => res.json())
  .then(data => {

    currentMonth = data.month;
    allData = data.records;

    document.getElementById("monthBox").innerText =
      "Current Month: " + currentMonth;

    loadFileFilter(allData);
    loadClientFilter(allData);

  });


// LOAD FILE FILTER

function loadFileFilter(data) {

  const set = new Set();

  data.forEach(d => set.add(d["File"]));

  const select = document.getElementById("fileFilter");

  select.innerHTML = `<option value="all">All</option>`;

  [...set].forEach(f => {
    select.innerHTML += `<option>${f}</option>`;
  });

  select.onchange = onFileChange;
}


// LOAD CLIENT FILTER

function loadClientFilter(data) {

  const set = new Set();

  data.forEach(d => set.add(d["Client Name"]));

  const select = document.getElementById("clientFilter");

  select.innerHTML = `<option value="all">All</option>`;

  [...set].forEach(c => {
    select.innerHTML += `<option>${c}</option>`;
  });

  select.onchange = onClientChange;
}


// FILE â†’ CLIENT CASCADE

function onFileChange() {

  const file = fileFilter.value;

  let filtered = allData;

  if (file !== "all") {
    filtered = allData.filter(d => d["File"] === file);
  }

  loadClientFilter(filtered);

  filterData();
}


// CLIENT â†’ FILE CASCADE

function onClientChange() {

  const client = clientFilter.value;

  let filtered = allData;

  if (client !== "all") {
    filtered = allData.filter(d => d["Client Name"] === client);
  }

  loadFileFilter(filtered);

  filterData();
}


// CLEAR BUTTONS

function clearFile() {

  fileFilter.value = "all";

  loadClientFilter(allData);

  filterData();
}


function clearClient() {

  clientFilter.value = "all";

  loadFileFilter(allData);

  filterData();
}


// MAIN FILTER LOGIC

function filterData() {

  const file = fileFilter.value;
  const client = clientFilter.value;

  const tbody = document.getElementById("tableBody");
  const summary = document.getElementById("summaryBox");


  // BLANK BY DEFAULT
  if (file === "all" && client === "all") {

    tbody.innerHTML = "";
    summary.innerHTML = "";

    return;
  }


  let filtered = allData;


  if (file !== "all") {
    filtered = filtered.filter(d => d["File"] === file);
  }

  if (client !== "all") {
    filtered = filtered.filter(d => d["Client Name"] === client);
  }


  renderTable(filtered);
}


// RENDER TABLE

function renderTable(data) {

  tableBody.innerHTML = "";
  summaryBox.innerHTML = "";

  if (!data.length) return;


  const summary = {};

  let totalR = 0;
  let totalP = 0;


  // Group by File + Client
  data.forEach(d => {

    const key = d["File"] + "||" + d["Client Name"];

    if (!summary[key]) {

      summary[key] = {
        file: d["File"],
        client: d["Client Name"],
        r: 0,
        p: 0
      };
    }

    const amt = Number(d["Amount"]);
    const tag = d["Tag - Receivable / (Payable)"];


    if (tag === "R") {

      summary[key].r += amt;
      totalR += amt;
    }

    if (tag === "P") {

      summary[key].p += Math.abs(amt);
      totalP += Math.abs(amt);
    }

  });


  const net = totalR - totalP;


  // Summary
  summaryBox.innerHTML = `
    Assets: ${format(totalR)} |
    Liabilities: ${format(totalP)} |
    Net:
    <span class="${net>=0?'positive':'negative'}">
      ${format(net)}
    </span>
  `;


  // Table rows
  for (let k in summary) {

    const row = summary[k];

    const n = row.r - row.p;

    tableBody.innerHTML += `
      <tr>
        <td>${row.file}</td>
        <td>${row.client}</td>
        <td>${format(row.r)}</td>
        <td>${format(row.p)}</td>
        <td class="${n>=0?'positive':'negative'}">
          ${format(n)}
        </td>
      </tr>
    `;
  }
}



  const net = totalR - totalP;


  summary.innerHTML = `
    Assets: ${format(totalR)} |
    Liabilities: ${format(totalP)} |
    Net:
    <span class="${net>=0?'positive':'negative'}">
      ${format(net)}
    </span>
  `;


  for (let c in clientSummary) {

    const r = clientSummary[c].r;
    const p = clientSummary[c].p;
    const n = r - p;

    tbody.innerHTML += `
      <tr>
        <td>${c}</td>
        <td>${format(r)}</td>
        <td>${format(p)}</td>
        <td class="${n>=0?'positive':'negative'}">
          ${format(n)}
        </td>
      </tr>
    `;
  }

}


// FORMAT NUMBER

function format(num) {

  return num.toLocaleString("en-IN");
}


// EXPORT PDF

function exportPDF() {

  document.getElementById("pdfHeader").classList.remove("pdf-only");


  pdfMonth.innerText = currentMonth;
  pdfFile.innerText = fileFilter.value;
  pdfClient.innerText = clientFilter.value;


  const element = document.getElementById("pdfArea");


  const opt = {

    margin: 10,
    filename: "Loan_Statement.pdf",

    image: { type: 'jpeg', quality: 0.98 },

    html2canvas: { scale: 2 },

    jsPDF: {
      unit: 'mm',
      format: 'a4',
      orientation: 'portrait'
    }

  };


  html2pdf().set(opt).from(element).save().then(() => {

    document.getElementById("pdfHeader").classList.add("pdf-only");

  });

}

</script>

</body>
</html>

