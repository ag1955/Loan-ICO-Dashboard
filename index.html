<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>ICO Loan Dashboard</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>

/* THEME */

:root {
  --primary: #0f2a44;
  --secondary: #1e4e79;
  --light-bg: #f4f7fb;
  --card-bg: #ffffff;
  --border: #dce3ec;
  --success: #1b8f3c;
  --danger: #c0392b;
  --button: #2563eb;
}

/* BASE */

body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: var(--light-bg);
  margin: 0;
  padding: 15px;
}

h2 {
  color: var(--primary);
  margin-bottom: 5px;
}

h3 {
  color: var(--secondary);
  margin-top: 0;
}

/* FILTERS */

.filters {
  background: var(--card-bg);
  padding: 15px;
  border-radius: 8px;
  border: 1px solid var(--border);
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  margin: 15px 0;

  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.filter-box {
  display: flex;
  flex-direction: column;
  min-width: 180px;
  flex: 1;
}

.filter-box label {
  font-weight: 600;
  margin-bottom: 3px;
}

/* INPUT */

select {
  padding: 8px;
  border-radius: 5px;
  border: 1px solid var(--border);
  width: 100%;
}

button {
  padding: 9px 14px;
  border: none;
  border-radius: 5px;
  background: var(--button);
  color: white;
  font-weight: 500;
  cursor: pointer;
}

button:hover {
  opacity: 0.9;
}

/* SUMMARY */

.summary {
  background: var(--card-bg);
  padding: 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  margin-top: 15px;
  font-size: 15px;
}

/* TABLE */

.table-wrapper {
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  background: var(--card-bg);
  border-radius: 8px;
  min-width: 600px;
}

th {
  background: var(--primary);
  color: white;
  padding: 10px;
}

td {
  padding: 8px;
  border-bottom: 1px solid var(--border);
  text-align: center;
}

tr:hover {
  background: #f1f6fc;
}

.positive {
  color: var(--success);
  font-weight: bold;
}

.negative {
  color: var(--danger);
  font-weight: bold;
}

/* PDF */

.pdf-only {
  display: none;
}

/* MOBILE */

@media (max-width: 600px) {

  .filters {
    flex-direction: column;
  }

  table {
    font-size: 13px;
  }
}

</style>
</head>


<body>

<h2>ICO Loan Portfolio Dashboard</h2>
<h3 id="monthBox"></h3>


<!-- FILTERS -->

<div class="filters">

  <div class="filter-box">
    <label>File</label>
    <select id="fileFilter"></select>
    <button onclick="clearFile()">Clear</button>
  </div>

  <div class="filter-box">
    <label>Client</label>
    <select id="clientFilter"></select>
    <button onclick="clearClient()">Clear</button>
  </div>

  <div class="filter-box">
    <label>&nbsp;</label>
    <button onclick="exportPDF()">ðŸ“„ Export PDF</button>
  </div>

</div>


<!-- OUTPUT -->

<div id="pdfArea">


  <!-- PDF HEADER -->

  <div id="pdfHeader" class="pdf-only">

    <h2>ICO Loan Statement</h2>

    <p><b>Month:</b> <span id="pdfMonth"></span></p>
    <p><b>File:</b> <span id="pdfFile"></span></p>
    <p><b>Client:</b> <span id="pdfClient"></span></p>

    <hr>

  </div>


  <!-- SUMMARY -->

  <div class="summary" id="summaryBox"></div>


  <!-- TABLE -->

  <div class="table-wrapper">

    <table>

      <thead>
        <tr>
          <th>File</th>
          <th>Client</th>
          <th>Receivable</th>
          <th>Payable</th>
          <th>Net Balance</th>
        </tr>
      </thead>

      <tbody id="tableBody"></tbody>

    </table>

  </div>

</div>


<script>

/* API */

const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjttJskl7kQamicK4CXBiqr5RIkQ0KhYNnHgAseLlknSDYsLI40rkv2Nzgtr0KdZpK-LKuoSkeAlH3fV47qAcAO90oHsPkv5w4zUScHCV_cdXUJyZaXRmv-BKp5vCFEeE4tRnDP9DmBVi1C_4kLcWjtnZgXfsYpkt2JR5GXBE15vmJpT_M3qhPFhDQSse9qu6b7hn6JSEGMqTAQ7pDMM3qWhOzrK7hEWdHQyd8Bms4rfJ2YjYTUxjJngydx6CisLlaU6LbIUOrRwBPS3AD4o6h3q7C9kQ&lib=M-FDxnB1VGCZDyM5l-Eicf7eUs6YUnKQP";


/* DOM */

const fileFilter = document.getElementById("fileFilter");
const clientFilter = document.getElementById("clientFilter");
const tableBody = document.getElementById("tableBody");
const summaryBox = document.getElementById("summaryBox");
const monthBox = document.getElementById("monthBox");

const pdfHeader = document.getElementById("pdfHeader");
const pdfArea = document.getElementById("pdfArea");
const pdfMonth = document.getElementById("pdfMonth");
const pdfFile = document.getElementById("pdfFile");
const pdfClient = document.getElementById("pdfClient");


/* DATA */

let allData = [];
let currentMonth = "";


/* LOAD */

fetch(API_URL)
  .then(res => res.json())
  .then(data => {

    currentMonth = data.month;
    allData = data.records || [];

    monthBox.innerText = "Current Month: " + currentMonth;

    loadFileFilter(allData);
    loadClientFilter(allData);

  })
  .catch(err => {

    alert("Failed to load data. Check API URL.");
    console.error(err);

  });


/* LOAD FILES */

function loadFileFilter(data) {

  const set = new Set();

  data.forEach(d => set.add(d["File"]));

  fileFilter.innerHTML = `<option value="all">All</option>`;

  [...set].forEach(f => {
    fileFilter.innerHTML += `<option>${f}</option>`;
  });

  fileFilter.onchange = onFileChange;
}


/* LOAD CLIENTS */

function loadClientFilter(data) {

  const set = new Set();

  data.forEach(d => set.add(d["Client Name"]));

  clientFilter.innerHTML = `<option value="all">All</option>`;

  [...set].forEach(c => {
    clientFilter.innerHTML += `<option>${c}</option>`;
  });

  clientFilter.onchange = onClientChange;
}


/* FILE â†’ CLIENT */

function onFileChange() {

  const file = fileFilter.value;

  let filtered = allData;

  if (file !== "all") {
    filtered = allData.filter(d => d["File"] === file);
  }

  loadClientFilter(filtered);

  filterData();
}


/* CLIENT â†’ FILE (SHOW ALL FILES) */

function onClientChange() {

  const client = clientFilter.value;

  if (client === "all") {

    loadFileFilter(allData);
    filterData();

    return;
  }


  const filtered = allData.filter(
    d => d["Client Name"] === client
  );


  loadFileFilter(filtered);

  fileFilter.value = "all";

  filterData();
}


/* CLEAR */

function clearFile() {

  fileFilter.value = "all";

  loadClientFilter(allData);

  filterData();
}


function clearClient() {

  clientFilter.value = "all";

  loadFileFilter(allData);

  filterData();
}


/* FILTER */

function filterData() {

  const file = fileFilter.value;
  const client = clientFilter.value;


  // Blank default
  if (file === "all" && client === "all") {

    tableBody.innerHTML = "";
    summaryBox.innerHTML = "";

    return;
  }


  let filtered = allData;


  if (file !== "all") {
    filtered = filtered.filter(d => d["File"] === file);
  }

  if (client !== "all") {
    filtered = filtered.filter(d => d["Client Name"] === client);
  }


  renderTable(filtered);
}


/* RENDER */

function renderTable(data) {

  tableBody.innerHTML = "";
  summaryBox.innerHTML = "";

  if (!data.length) return;


  const summary = {};

  let totalR = 0;
  let totalP = 0;


  data.forEach(d => {

    const key = d["File"] + "||" + d["Client Name"];

    if (!summary[key]) {

      summary[key] = {
        file: d["File"],
        client: d["Client Name"],
        r: 0,
        p: 0
      };
    }

    const amt = Number(d["Amount"]);
    const tag = d["Tag - Receivable / (Payable)"];


    if (tag === "R") {

      summary[key].r += amt;
      totalR += amt;
    }

    if (tag === "P") {

      summary[key].p += Math.abs(amt);
      totalP += Math.abs(amt);
    }

  });


  const net = totalR - totalP;


  summaryBox.innerHTML = `
    Assets: ${format(totalR)} |
    Liabilities: ${format(totalP)} |
    Net:
    <span class="${net>=0?'positive':'negative'}">
      ${format(net)}
    </span>
  `;


  for (let k in summary) {

    const row = summary[k];

    const n = row.r - row.p;

    tableBody.innerHTML += `
      <tr>
        <td>${row.file}</td>
        <td>${row.client}</td>
        <td>${format(row.r)}</td>
        <td>${format(row.p)}</td>
        <td class="${n>=0?'positive':'negative'}">
          ${format(n)}
        </td>
      </tr>
    `;
  }

}


/* FORMAT */

function format(n) {

  return n.toLocaleString("en-IN");
}


/* PDF */

function exportPDF() {

  pdfHeader.classList.remove("pdf-only");


  pdfMonth.innerText = currentMonth;
  pdfFile.innerText = fileFilter.value;
  pdfClient.innerText = clientFilter.value;


  const opt = {

    margin: 10,
    filename: "Loan_Statement.pdf",

    image: { type: 'jpeg', quality: 0.98 },

    html2canvas: { scale: 2 },

    jsPDF: {
      unit: 'mm',
      format: 'a4',
      orientation: 'portrait'
    }

  };


  html2pdf().set(opt).from(pdfArea).save().then(() => {

    pdfHeader.classList.add("pdf-only");

  });

}

</script>

</body>
</html>
